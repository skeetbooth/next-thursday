<div id="map"></div>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const words = urlParams.get('words');
    const wordsBreakLine = words.split('.').join('</br>')
    var target = '';
    var bounds = {};
    
    what3words.api.convertToCoordinates(words).then(function(response) {
        target = {
            'lat': response.coordinates.lat,
            'lng': response.coordinates.lng,
        };
        
        var north = target.lat + .000014;
        var south = target.lat - .0000135;
        var east = target.lng + .000015;
        var west = target.lng - .000015;
        bounds = {
            north: north,
            south: south,
            east: east,
            west: west
        }
    
        let map = new google.maps.Map(document.getElementById("map"), {
            center: target,
            zoom: 20,
            mapTypeId: 'satellite',
            streetViewControl: false,
            fullscreenControl: false
        });

        var rectangle = new google.maps.Rectangle({
            strokeColor: '#00aeef',
            strokeOpacity: 1,
            strokeWeight: .01,
            fillColor: '#00aeef',
            fillOpacity: .9,
            map: map,
            bounds: bounds
        });

        var marker = new google.maps.Marker({
            position: target,
            map: map,
            visible: false
        });

        var contentString = '<div id="content">'+
            '<div id="siteNotice">'+
            '</div>'+
            '<h1 id="header" class="info-window">' + wordsBreakLine + '</h1>'+
            '</div>'+
            '</div>';
      
        var infowindow = new google.maps.InfoWindow({
          content: contentString,
          pixelOffset: {width: 0, height: -40}
        });

        console.log('[map]', map)
        infowindow.close();
        infowindow.open(map, marker);

        rectangle.addListener('click', function() {
            infowindow.close();
            infowindow.open(map, marker);
        });

     
        var gridData;
    
        // Add the what3words grid to the Google Map data layer once the desired zoom level is meet
        map.addListener('bounds_changed', function() {
            console.log('pop');
            const zoom = map.getZoom();
            const loadFeatures = zoom > 17;
            if (loadFeatures) { // Zoom level is high enough
    
                var ne = map.getBounds().getNorthEast();
                var sw = map.getBounds().getSouthWest();
    
    
                // Call the what3words Grid API to obtain the grid squares within the current visble bounding box
                what3words.api
                    .gridSectionGeoJson({
                        southwest: {
                            lat: sw.lat(),
                            lng: sw.lng()
                        },
                        northeast: {
                            lat: ne.lat(),
                            lng: ne.lng()
                        }
                    }).then(function(data) {
                        if (gridData !== undefined) {
                            for (var i = 0; i < gridData.length; i++) {
                                map.data.remove(gridData[i]);
                            }
                        }
                        gridData = map.data.addGeoJson(data);
                    }).catch(console.error);
            }

        // Set the grid display style
        map.data.setStyle({
            visible: loadFeatures,
            strokeColor: '#000',
            strokeWeight: .2,
            clickable: false
        });
        });
    });
</script>
<style>
    #map {
        height: 900px;
    }

    .gm-style-iw {
        max-width: 75vw !important;
    }

    #header {
        color: #212331;
        margin: 0;
        word-break: break-all;
        line-height: 1;
    }

    html, body {
        height: 900px;
        margin: 0;
        padding: 0;
    }
</style>
