<div id="message">
    <p>See you at our old address on Thursday, 16th July @ 236 Arthur St, Newstead</p>
    <p>Click <a href="https://what3words.com/" id="cta-link" target="_blank">here</a> to use your unique three words to navigate to our brand spanking new address.</p>
</div>

<div id="map"></div>
<script>
    const urlParams = new URLSearchParams(window.location.search);
    const words = urlParams.get('words');
    const wordsOutput = document.getElementById('cta-link')
    const wordsBreakLine = words.split('.').join('</br>')
    const ctaLink = document.getElementById('cta-link')
    const message = document.getElementById('message')
    let target = ''
    let bounds = {}
    
    console.log('message: ', message)
   

    ctaLink.href = 'https://what3words.com/' + words
    wordsOutput.href = 'https://what3words.com/' + words;
    
    what3words.api.convertToCoordinates(words).then(function(response) {
      target = {
        'lat': response.coordinates.lat,
        'lng': response.coordinates.lng,
      };
    
      const north = target.lat + .000014
      const south = target.lat - .0000135
      const east = target.lng + .000015
      const west = target.lng - .000015
      bounds = {
        north: north,
        south: south,
        east: east,
        west: west
      }
    
      let map = new google.maps.Map(document.getElementById("map"), {
        center: target,
        zoom: 20,
        mapTypeId: 'satellite',
        streetViewControl: false,
        fullscreenControl: false
      });
    
      const rectangle = new google.maps.Rectangle({
        strokeColor: '#e7ff89',
        strokeOpacity: 1,
        strokeWeight: 2,
        fillColor: '#00aeef',
        fillOpacity: .9,
        map: map,
        bounds: bounds
      });
    
      const marker = new google.maps.Marker({
        position: target,
        map: map,
        visible: false
      });
    
      const contentString = '<div id="content">' +
        '<div id="siteNotice">' +
        '</div>' +
        '<h1 id="header" class="info-window">' + wordsBreakLine + '</h1>' +
        '</div>' +
        '</div>'
    
      const infowindow = new google.maps.InfoWindow({
        content: contentString,
        pixelOffset: {
          width: 0,
          height: -40
        }
      });
    
      infowindow.close();
      infowindow.open(map, marker);
    
      rectangle.addListener('click', function() {
        infowindow.close()
        infowindow.open(map, marker)
      });
    
      let gridData;
    
      // Add the what3words grid to the Google Map data layer once the desired zoom level is meet
      map.addListener('bounds_changed', function() {
        const zoom = map.getZoom()
        const loadFeatures = zoom > 17;
        if (loadFeatures) {
          const ne = map.getBounds().getNorthEast()
          const sw = map.getBounds().getSouthWest()
    
          // Call the what3words Grid API to obtain the grid squares within the current visble bounding box
          what3words.api
            .gridSectionGeoJson({
              southwest: {
                lat: sw.lat(),
                lng: sw.lng()
              },
              northeast: {
                lat: ne.lat(),
                lng: ne.lng()
              }
            }).then(function(data) {
              if (gridData !== undefined) {
                for (let i = 0; i < gridData.length; i++) {
                  map.data.remove(gridData[i])
                }
              }
              gridData = map.data.addGeoJson(data);
            }).catch(console.error)

        }

        // Set the grid display style
        map.data.setStyle({
          visible: loadFeatures,
          strokeColor: '#000',
          strokeWeight: .2,
          clickable: false
        })
      })
    }).catch(function (error) {
        console.log('error: ', error)
        message.innerHTML = "Not a valid what3words address"
        map.classList.add('hidden')
        return null;
    })
</script>
<style>
    #map {
        height: 900px;
        margin-bottom: 4rem;
    }

    .hidden {
        display: none;
    }
    
    .gm-style-iw {
        max-width: 75vw !important;
    }
    
    .gm-style-iw-d {
        overflow: hidden !important;
        padding: 1px 10px 10px 1px !important;
    }
    
    #words {
       font-weight: bold;
    }
   
    #message {
       margin: 4rem 0;
    }

    #header {
        color: #00aeef;
        margin: 0;
        word-break: break-all;
        line-height: 1;
    }

    html, body {
        height: 900px;
        margin: 0;
        padding: 0;
    }
</style>
